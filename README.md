This is a [Next.js](https://nextjs.org/) project bootstrapped with [`create-next-app`](https://github.com/vercel/next.js/tree/canary/packages/create-next-app).

## Getting Started

### Environment Setup

Copy the `.env.sample` file to `.env.local`:

```
NEXT_PUBLIC_API_URL=http://localhost:3001/api
```

### Development Server

First, start the API server:

```bash
cd apps/api
npm run start:dev
```

Then, in a separate terminal, run the web development server:

```bash
cd apps/web
npm run dev
# or
yarn dev
```

Open [http://localhost:3000](http://localhost:3000) with your browser to see the result.

## Supabase Integration

This project uses [Supabase](https://supabase.com/) for secure storage of audio files, but only through the NestJS API backend. The audio files are stored in a private bucket named "songs" in Supabase Storage with access controlled via signed URLs that are generated by the API.

### Storage Setup

1. Create a Supabase project
2. Create a storage bucket named "songs" (private bucket, not public)
3. Upload your audio files to the bucket
4. Set up the following Row Level Security (RLS) policy for the bucket:
   - **SELECT policy name**: "Allow access via signed URLs"
   - **Using expression**: `true`
   - This allows the application to generate signed URLs for temporary access

The backend API will handle retrieving signed URLs for the songs, which expire after a specified time (default is 1 hour).

## API Integration

This project now exclusively uses a NestJS API backend for retrieving songs and signed URLs. The API follows Clean Architecture and Domain-Driven Design principles:

### API Structure

- **Domain Layer**: Contains core business logic and interfaces
- **Application Layer**: Contains use cases that orchestrate domain operations
- **Infrastructure Layer**: Contains implementations of repositories and services
- **Presentation Layer**: Contains controllers and modules for HTTP endpoints

### API Endpoints

- `GET /api/songs` - Get all songs
- `GET /api/songs/signed-url/:filename` - Generate a signed URL for a song file

The API is configured to run on port 3001 by default, and the web application exclusively uses these endpoints to fetch song data and signed URLs for audio files, with no direct connection to Supabase.

## Security Improvements

By using exclusively the server-side API for Supabase interactions:

1. Supabase credentials remain completely server-side and are never exposed to the client
2. Better control over URL expiration and access policies
3. Centralized logging and error handling
4. Ability to implement caching or rate limiting at the API level

## Troubleshooting

### API Connection Issues

If you experience issues connecting to the API:

1. Make sure the API server is running
2. Check that the `NEXT_PUBLIC_API_URL` environment variable is correctly set
3. The API client includes retry logic for transient errors

### Audio Timeline Issues

If the audio timeline is not updating correctly:

1. Check that the audio element has loaded the metadata properly
2. Ensure the `timeUpdate` event handler is being called
3. Verify that the audio duration is a valid number (not NaN)

The Player component includes several fixes to ensure proper timeline functionality:
- Adding checks for NaN duration values
- Properly resetting the timeline when switching songs
- Adding the `onLoadedMetadata` event handler
- Improved error handling for audio playback

## Learn More

To learn more about Next.js, take a look at the following resources:

- [Next.js Documentation](https://nextjs.org/docs) - learn about Next.js features and API.
- [Learn Next.js](https://nextjs.org/learn) - an interactive Next.js tutorial.

You can check out [the Next.js GitHub repository](https://github.com/vercel/next.js/) - your feedback and contributions are welcome!

## Deploy on Vercel

The easiest way to deploy your Next.js app is to use the [Vercel Platform](https://vercel.com/new?utm_medium=default-template&filter=next.js&utm_source=create-next-app&utm_campaign=create-next-app-readme) from the creators of Next.js.

Check out our [Next.js deployment documentation](https://nextjs.org/docs/deployment) for more details.

When deploying to Vercel, make sure to add the environment variables in the Vercel project settings.

## Security Considerations

- Signed URLs expire after a set time (default: 1 hour)
- The application automatically refreshes URLs before they expire
- This approach provides secure access to private files without requiring user authentication
- For more security, you can adjust the expiration time of signed URLs in the codebase
